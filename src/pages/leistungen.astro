---
import { getEntry, getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Button from '../components/Button.astro';

const services = await getCollection('services');
const sortedServices = services.sort((a, b) => (a.data.order || 99) - (b.data.order || 99));

// 1. Fetch data from the 'services' page content (for banner/header)
const entry = await getEntry('pages', 'services');

// 2. Defensive Coding: Extract data with fallbacks
const { title: pageTitle, headerBanner, seo, cta_section } = entry?.data || {};

// 3. Define Fallback Constants
const DEFAULT_BANNER_IMAGE = '/assets/uploads/default-service-banner.jpg'; // Ensure this exists or use a generic placeholder
const FALLBACK_TITLE = 'Unsere Leistungen';
const FALLBACK_BANNER_TEXT = 'Professionelle Dienstleistungen für jeden Bedarf';
const FALLBACK_CTA = {
  heading: 'Interesse an unseren Leistungen?',
  content: 'Kontaktieren Sie uns für ein unverbindliches Angebot',
  button_text: 'Jetzt Kontakt aufnehmen',
  button_link: '/kontakt'
};

// 4. Resolve final values
// User wants "Titel" from CMS (pageTitle) to be the main H1. headerBanner.text will be the subtitle.
const finalTitle = pageTitle || FALLBACK_TITLE;
const finalSubtitle = headerBanner?.text || FALLBACK_BANNER_TEXT;
const finalImage = headerBanner?.image || DEFAULT_BANNER_IMAGE;
const isBannerEnabled = headerBanner?.enabled !== false; // Default to true if not specified
const bannerVariant = headerBanner?.variant || 'dark';

const finalCTA = {
  heading: cta_section?.heading || FALLBACK_CTA.heading,
  content: cta_section?.content || FALLBACK_CTA.content,
  button_text: cta_section?.button_text || FALLBACK_CTA.button_text,
  button_link: cta_section?.button_link || FALLBACK_CTA.button_link
};

// 5. Build the banner object for BaseLayout
const computedHeaderBanner = {
  enabled: isBannerEnabled,
  text: finalTitle,
  image: finalImage,
  variant: bannerVariant,
  // cta_label and cta_link are not in the new schema yet, so omitting or adding if needed
};

---

<BaseLayout 
  title={seo?.title || "Unsere Leistungen - MIGA Dienstleistungen GmbH"}
  description={seo?.description || "Professionelle Dienstleistungen: Reinigung, Grünflächenpflege, Winterdienst, Transport, Tischler-, Montage-, Bauarbeiten, Sanitär und KFZ-Service in Graz."}
  headerBanner={computedHeaderBanner}
>
  <!-- Header -->
  <!-- Header -->
  <section class="relative bg-gradient-to-r from-primary-600 to-primary-700 text-white py-16 overflow-hidden">
    {finalImage && finalImage !== DEFAULT_BANNER_IMAGE && (
      <div class="absolute inset-0 z-0">
        <img 
          src={finalImage} 
          alt={finalTitle} 
          class="w-full h-full object-cover opacity-90" 
        />
        <div class="absolute inset-0 bg-gradient-to-r from-black/40 to-black/20"></div>
      </div>
    )}
    
    <div class="container-custom relative z-10 drop-shadow-lg">
      <h1 class="heading-1 text-white mb-4">{finalTitle}</h1>
      <p class="text-xl text-white font-medium">{finalSubtitle}</p>
    </div>
  </section>

  <!-- Services -->
  <section class="section bg-white">
    <div class="container-custom">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {sortedServices.map((service, index) => (
        <a href={`/leistungen/${service.slug}`} class="group block h-full">
          <div class="card overflow-hidden h-full flex flex-col hover:shadow-lg transition-all duration-300 border border-gray-100 group-hover:border-primary-200">
              {(service.data as any).image && (
                <div class="h-48 relative overflow-hidden">
                   <img 
                    src={(service.data as any).image} 
                    alt={service.data.title} 
                    class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                    loading="lazy"
                  />
                </div>
              )}
              <div class="p-6 flex-grow flex flex-col">
                <h2 class="heading-4 mb-3 text-primary-600 group-hover:text-primary-700 transition-colors">
                    {service.data.title}
                </h2>
                <p class="mb-4 text-dark-600 line-clamp-3">{service.data.description}</p>
                <div class="mt-auto">
                    <span class="text-sm font-semibold text-primary-600 flex items-center">
                        Mehr erfahren
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 transform transition-transform group-hover:translate-x-1" viewBox="0 0 20 20" fill="currentColor">
                             <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </span>
                </div>
              </div>
          </div>
        </a>
      ))}
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="section bg-gradient-to-r from-primary-600 to-primary-700 text-white">
    <div class="container-custom text-center">
      <h2 class="heading-2 text-white mb-6">{finalCTA.heading}</h2>
      <p class="text-xl text-primary-50 mb-8">{finalCTA.content}</p>
      <Button href={finalCTA.button_link} variant="primary" size="lg" class="shadow-xl">{finalCTA.button_text}</Button>
    </div>
  </section>
</BaseLayout>
